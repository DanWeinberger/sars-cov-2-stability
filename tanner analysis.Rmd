---
title: "Tanner analysis"
output: html_notebook
---


```{r setup}
library(dplyr)
library(readxl)
library(reshape2)
library(MASS)
library(lme4)
library(ggplot2)
```

The goal for this analysis is to evaluate survival of SARS-CoV-2 on different surfaces. We have experimental data, in triplicate, for different variants, humidity levels, and surfaces. The relevant baseline period is '0 hours dry'. Note that replicates are not longitundinal (i.e., replate 1B is not from same tile as 2B), so they should be treated independently.

```{r, echo=F}

sheets <- c('4-5-22 experiments', '4-27-22 experiments', '5-3-22 experiments', '6-7-22 experiments', '6-15-22 experiments', '6-22-22 experiments','8-3-22 experiments','8-16-22 experiments','8-30-22 experiments' )

a1a <- lapply(sheets, function(x) read_excel('./dat/CONFIDENTIAL/20220919_Surface_Infectivity_Decay_study_for_R.xlsx', sheet=x) %>%
                rename(dil_1=`Cell culture plaque count 10^-1`,
                       dil_2=`Cell culture plaque count 10^-2`,
                       dil_3=`Cell culture plaque count 10^-3`,
                       dil_4=`Cell culture plaque count 10^-4`,
              ) %>%
                mutate(dil_1 = as.numeric(dil_1),
                       dil_2 = as.numeric(dil_2),
                       dil_3 = as.numeric(dil_3),
                       dil_4 = as.numeric(dil_4),
                       
                       )
)

a1 <- a1a %>%
  bind_rows() %>%
  filter(!(grepl("0 hours wet" , `Time point (post inoculation)` ))) %>%
  mutate(time = gsub('hours', '',`Time point (post inoculation)`),
         time = as.numeric(gsub('dry', '',time )),
        `Humidity level` = if_else(`Humidity level` %in% c(0.55, 0.6),0.6, `Humidity level` ) ) %>%
  rename(replicate=`Replicate number`,
         surface='Surface material',  
         humidity='Humidity level',
         temp='Temperature'
         )

a1$humidity[a1$humidity==60] <- 0.6

names(a1) <- gsub("Cell culture plaque count 10\\^",'dil', names(a1))

write.csv(a1, './dat/CONFIDENTIAL/cleaned.csv')

```

Fill 0s for more dilute if less dilute had virus
```{r}

a1$dil_2[is.na(a1$dil_2) & !is.na(a1$dil_1) ] <- 0
a1$dil_3[is.na(a1$dil_3) & !is.na(a1$dil_2) ] <- 0
a1$dil_4[is.na(a1$dil_4) & !is.na(a1$dil_3) ] <- 0

```


```{r}
a1.ma <- melt (a1, id.vars=c('temp','time', 'humidity','surface','replicate','variant','date')) %>%
  filter(variable != 'Time point (post inoculation)') %>%
  mutate(variable= as.character(variable), 
           dilution=as.numeric(gsub("dil_",'', variable) )) %>%
  arrange(temp, time, humidity, surface, replicate, variant, date,desc(dilution)) %>%
  group_by(temp, time, humidity, surface, variant, date, replicate) %>%
  mutate(value= as.numeric(as.character(value)), concentration= value/10^dilution, 
         countable= !is.na(value), 
         wgt = countable*10^dilution/sum(countable*10^dilution)  ) %>%
  summarize( concentration=sum(concentration*wgt, na.rm=T)) %>%
 mutate(concentration= if_else(concentration==0, 9.99e-8, concentration), 
        unique_replicate= cur_group_id(),
        log10_titer=log10(concentration), 
        humidity=as.factor(humidity)) %>%
    group_by(temp, time, humidity, surface, variant, date) %>%
   mutate(mean_conc_condition=mean(concentration, na.rm=T)) %>%
  ungroup() %>%
    mutate( temp=as.factor(temp), surface=as.factor(surface), variant=as.factor(variant))


#once sample is negative, stop tracking it
censor_time <- a1.ma %>%
  group_by(temp, time, humidity, surface, variant, date)%>%
  summarize(mean_conc_condition=mean(mean_conc_condition)) %>%
  ungroup() %>%
    arrange(temp,  humidity, surface, variant, date, time) %>%
    group_by(temp,  humidity, surface, variant) %>%
  mutate(lag_conc=lag(mean_conc_condition,1), CENSOR=if_else(lag_conc< 1e-7 ,1, 0) ) %>%
  ungroup() %>%
  dplyr::select(temp,  humidity, surface, variant, time, CENSOR) 

a1.m <- merge(a1.ma, censor_time, by=c('temp',  'humidity', 'surface', 'variant', 'time')) %>%
      arrange(temp,  humidity, surface, variant, date, time) %>%
  filter( (is.na(CENSOR) | CENSOR ==0)  & concentration > 1e-7) 
  

  

```

Some descriptive plots
```{r, fig.width=6,fig.height=6}

ggplot(a1.m, aes(x=time, y=log10_titer, group=humidity, col=humidity ) ) +
  geom_point()+
  theme_classic() +
  facet_wrap(variant~surface)+
  geom_hline(yintercept=log10(999e-10),lty=2, col='grey') 
```

```{r}
ggplot(a1.m, aes(x=time, y=log10_titer, group=variant, col=variant ) ) +
  geom_point()+
  theme_classic() +
  facet_wrap(~surface)
```

Half life for plastic, steel not significantly different than aluminum

```{r}

mod1 <- lm(log10_titer ~ 0 +surface + time + humidity + variant + humidity*time +surface*time, data=a1.m)  #+ (time|unique_replicate), data=a1.m)

summary(mod1)

coefs1 <- coef(mod1)

#t_half_alum <- (coefs1['surfaceAluminum'] - log10((10^coefs1['surfaceAluminum'])/2 ))/(-1*(coefs1['time']))
#for 30 percnt humidity
t_half_alum30 = log10(0.5)/(coefs1['time'])

t_half_ss30 = log10(0.5)/(coefs1['time'] + coefs1['surfaceStainless steel:time'])

t_half_plastic30 = log10(0.5)/(coefs1['time'] + coefs1['surfaceTextured plastic:time'])

#t_half_ss <- (coefs1['surfaceStainless steel'] - log10((10^coefs1['surfaceStainless steel'])/2 ))/(-1*(coefs1['time'] +coefs1['surfaceStainless steel:time']  ))

#t_half_ss = log10(0.5)/(coefs1['time'] + coefs1['surfaceStainless steel:time'])


#t_half_ss <- (3.49 - log10((10^3.49)/2 ))/(0.017361- 0.007243 )

#t_half_plastic <- (3.70 - log10((10^3.70)/2 ))/(0.017361- 0.004710 )



t_half_alum30
t_half_ss30
t_half_plastic30

```


WA01 slower than alpha and delta.
```{r}

mod2 <- lm(log10_titer ~ 1 + time + humidity + surface + variant + time*surface + time*humidity + time*variant +time*humidity*variant*surface, data=a1.m)  #+ (time|unique_replicate), data=a1.m)

summary(mod2)

coefs2 <- coef(mod2)

#t_half_alum <- (coefs1['surfaceAluminum'] - log10((10^coefs1['surfaceAluminum'])/2 ))/(-1*(coefs1['time']))
t_half_alpha_30_al = log10(0.5)/(coefs2['time'])
t_half_alpha_60_al = log10(0.5)/(coefs2['time'] + coefs2['time:humidity0.6'])

t_half_Delta30_al = log10(0.5)/(coefs2['time'] + coefs2['time:variantDelta'])
t_half_Delta60_al = log10(0.5)/(coefs2['time'] + coefs2['time:variantDelta'] + coefs2['time:humidity0.6'] + coefs2['time:humidity0.6:variantDelta'])



t_half_WA01_30_al = log10(0.5)/(coefs2['time'] + coefs2['time:variantWA01'])
t_half_WA01_60_al = log10(0.5)/(coefs2['time'] + coefs2['time:variantWA01'] + coefs2['time:humidity0.6'] + coefs2['time:humidity0.6:variantWA01'])


t_half_alpha_30_al
t_half_alpha_60_al

t_half_Delta30_al
t_half_Delta60_al

t_half_WA01_30_al
t_half_WA01_60_al
```

 decay is significantly faster at 55-60% humidity vs 30% humidity (30h vs 10 h)
 
```{r}

mod3 <- lm(log10_titer ~ 1 + time + humidity + variant + time*humidity, data=a1.m)  #+ (time|unique_replicate), data=a1.m)

summary(mod3)

coefs3 <- coef(mod3)

#half life for 30% humidity, Alpha (averaged over surfaces)

t_half_30 = log10(0.5)/(coefs2['time'])

t_half_60 = log10(0.5)/(coefs3['time'] + coefs3['time:humidity0.6'])



t_half_30
t_half_60
```



## resampling to get uncertainty intervals

```{r}

mod3 <- lm(log10_titer ~ 0 + time + humidity +  time*humidity, data=a1.m)  #+ (time|unique_replicate), data=a1.m)

  pred.coefs.reg.mean <-
    mvrnorm(n = 10000,
            mu = mod3$coefficients,
            Sigma = vcov(mod3))
  
  
t_half_30 <- log10(0.5)/(pred.coefs.reg.mean[,'time'])

t_half_60 <- log10(0.5)/(pred.coefs.reg.mean[,'time']  + pred.coefs.reg.mean[,'time:humidity0.6'])

t_half_30_q <- quantile(t_half_30, probs=c(0.5, 0.025, 0.975))

t_half_60_q <- quantile(t_half_60, probs=c(0.5, 0.025, 0.975))

t_half_30_q
t_half_60_q
```



## Survival model
Failure time is time of censoring





## Side note: Exploring stats to combine  dilutions

Conclusion, take a weighted average of the concentrations, with the weight being proportional to the dilution. This is equivalent to the MLE estimate

```{r}
test <- c(4,5,60, 600)

```

without an offset, the max likelihood estimate is just the sample mean of the counts

```{r}

offset3 <- c(1,1,1,1)
mod3 <- glm(test ~ 1, family='poisson', offset=log(offset3))

exp(mod3$coefficients)

mean(test)
```

With an offset, the mean is the weighted mean of the rate is equal to the weighted average of the rate

```{r}
offset1 <- c(1,1,10,100)

mod1 <- glm(test ~ 1, family='poisson', offset=log(offset1))

exp(mod1$coefficients)

sum(test/offset1*offset1/sum(offset1)) #average, weighted by offset
```

ditto
```{r}

offset2 <- c(100,100,10,1)

df.test2 <- cbind.data.frame('y'=test, 'log_offset'=log(offset2))

mod2 <- glm(y ~ 1, family='poisson', offset=log_offset, data=df.test2)

exp(mod2$coefficients)

sum(test/offset2*offset2/sum(offset2))


```



